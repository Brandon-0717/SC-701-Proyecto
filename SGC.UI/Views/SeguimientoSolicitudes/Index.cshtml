@model List<SGC.Abstracciones.Modelos.ModeloDA.SolicitudCreditoDA>

@{
    ViewData["Title"] = "Seguimiento de Solicitudes de Crédito";
}

<h2 class="mb-4">Seguimiento de Solicitudes de Crédito</h2>

<!-- Anti-forgery token para fetch POST -->
<form asp-antiforgery="true"></form>

<table class="table table-bordered table-striped">
    <thead class="table-dark">
        <tr>
            <th># Solicitud</th>
            <th>Cliente</th>
            <th>Monto</th>
            <th>Estado</th>
            <th>Fecha</th>
            <th style="width: 260px;">Acciones</th>
        </tr>
    </thead>
    <tbody>
        @if (Model != null && Model.Count > 0)
        {
            foreach (var item in Model)
            {
                <tr>
                    <td>@item.SOLICITUDES_CREDITO_PK</td>

                    <td>@item.CLIENTES_FK_SOLICITUES_CREDITO</td>

                    <td>
                        ₡ @item.Monto_Credito.ToString("N2")
                    </td>

                    <td class="estado" data-id="@item.ESTADOS_FK_SOLICITUDES_CREDITO"></td>

                    <td>
                        @item.Fecha_Modificacion?.ToString("dd/MM/yyyy")
                    </td>

                    <!-- ========= ACCIONES POR ROL ========= -->
                    <td class="d-flex gap-1 flex-wrap">

                        @* ANALISTA y ADMINISTRADOR *@
                        @if (User.IsInRole("Analista") || User.IsInRole("Administrador"))
                        {
                            <button type="button"
                                    class="btn btn-sm btn-primary btn-enviar"
                                    data-id="@item.SOLICITUDES_CREDITO_PK">
                                Enviar
                            </button>
                        }

                        @* GESTOR y ADMINISTRADOR *@
                        @if (User.IsInRole("Gestor") || User.IsInRole("Administrador"))
                        {
                            <button type="button"
                                    class="btn btn-sm btn-success btn-aprobar"
                                    data-id="@item.SOLICITUDES_CREDITO_PK">
                                Aprobar
                            </button>

                            <button type="button"
                                    class="btn btn-sm btn-warning btn-devolver"
                                    data-id="@item.SOLICITUDES_CREDITO_PK">
                                Devolver
                            </button>
                        }

                    </td>
                </tr>
            }
        }
        else
        {
            <tr>
                <td colspan="6" class="text-center text-muted">
                    No hay solicitudes para mostrar
                </td>
            </tr>
        }
    </tbody>
</table>

@section Scripts {
    <script src="~/js/seguimiento-solicitudes.js"></script>

    <script>
        fetch('/Estado/ListarEstados')
            .then(r => r.json())
            .then(resp => {
                const estados = {};
                resp.data.forEach(e => estados[e.estadoS_PK] = e.nombre_Estado);

                document.querySelectorAll('.estado').forEach(td => {
                    const id = td.dataset.id;
                    td.innerText = estados[id] || 'N/A';
                });
            });
    </script>
}
